#!/usr/bin/env ruby
# frozen_string_literal: true

require 'rubygems'
require 'bundler/setup'
require 'i18n/tasks'
require 'open3'

module I18nTasksSync
  def self.add_missing_keys
    puts "Adding missing keys..."
    stdout, stderr, status = Open3.capture3('bundle exec i18n-tasks add-missing --nil-value')
    if status.success?
      puts "Successfully added missing keys."
    else
      raise "Add missing keys failed: #{stderr}"
    end
  end

  def self.remove_unused_keys
    puts "Removing unused keys..."
    stdout, stderr, status = Open3.capture3('yes | bundle exec i18n-tasks remove-unused')
    if status.success?
      puts "Successfully removed unused keys."
    else
      raise "Remove unused keys failed: #{stderr}"
    end
  end

  def self.auto_translate_missing_keys
    puts "Translating missing keys..."
    stdout, stderr, status = Open3.capture3('bundle exec i18n-tasks translate-missing --from=en --backend=openai')
    if status.success?
      puts "Successfully translated missing keys."
    else
      raise "Auto translate missing keys failed: #{stderr}"
    end
  end
end

begin
  I18nTasksSync.add_missing_keys
  I18nTasksSync.remove_unused_keys
  I18nTasksSync.auto_translate_missing_keys
  puts "Translation files have been synchronized and translated."
rescue => e
  puts "An error occurred during the I18nTasksSync process: #{e.message}"
end
