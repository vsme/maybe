#!/usr/bin/env ruby
# frozen_string_literal: true

require 'rubygems'
require 'bundler/setup'
require 'i18n/tasks'

module I18nTasksSync
  def self.add_missing_keys
    puts "Adding missing keys..."
    begin
      system('bundle exec i18n-tasks add-missing --nil-value')
      raise 'Add missing keys failed' unless $?.success?
    rescue => e
      puts "Error adding missing keys: #{e.message}"
    end
  end

  def self.remove_unused_keys
    puts "Removing unused keys..."
    begin
      system('yes | bundle exec i18n-tasks remove-unused')
      raise 'Remove unused keys failed' unless $?.success?
    rescue => e
      puts "Error removing unused keys: #{e.message}"
    end
  end

  def self.auto_translate_missing_keys
    puts "Translating missing keys..."
    begin
      # 使用 OpenAI 进行翻译
      system('bundle exec i18n-tasks translate-missing --from=en --backend=openai')
      raise 'Auto translate missing keys failed' unless $?.success?
    rescue => e
      puts "Error translating missing keys: #{e.message}"
    end
  end
end

begin
  I18nTasksSync.add_missing_keys
  I18nTasksSync.remove_unused_keys
  I18nTasksSync.auto_translate_missing_keys
  puts "Translation files have been synchronized and translated."
rescue => e
  puts "An error occurred during the I18nTasksSync process: #{e.message}"
end
